<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pantalla Digital - Comida R√°pida</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'TT Lakes Neue', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #000;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }

        .slideshow-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            background: #000;
        }

        .slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 1s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .slide.active {
            opacity: 1;
            z-index: 1;
        }

        .slide img,
        .slide video {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .no-images {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            font-size: 32px;
            z-index: 10;
        }

        .no-images-icon {
            font-size: 120px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 100;
            opacity: 1; /* Siempre visible */
            transition: opacity 0.3s ease;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: none;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .control-btn.active {
            background: rgba(255, 255, 255, 0.4);
            border: 2px solid rgba(255, 255, 255, 0.6);
        }

        .media-selector {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            max-width: 80%;
            max-height: 80%;
            overflow-y: auto;
            z-index: 200;
            display: none;
        }

        .media-selector.show {
            display: block;
        }

        .media-selector h3 {
            color: white;
            text-align: center;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .media-item {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            aspect-ratio: 16/9;
            background: #f0f0f0;
            cursor: pointer;
            transition: transform 0.2s ease;
            border: 3px solid transparent;
        }

        .media-item:hover {
            transform: scale(1.05);
        }

        .media-item.selected {
            border-color: #667eea;
        }

        .media-item img,
        .media-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .media-item .video-indicator {
            position: absolute;
            top: 5px;
            left: 5px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
        }

        .selector-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .selector-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .selector-btn:hover {
            background: #764ba2;
            transform: translateY(-2px);
        }

        .selector-btn.secondary {
            background: #6c757d;
        }

        .close-selector {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }

        .status-indicator {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 255, 0, 0.2);
            backdrop-filter: blur(10px);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 14px;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        body:hover .status-indicator {
            opacity: 1;
        }

        .image-counter {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 14px;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        body:hover .image-counter {
            opacity: 1;
        }

        /* Loading animation */
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
            z-index: 5;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
    </style>
</head>
<body>
    <div class="slideshow-container" id="slideshowContainer">
        <div class="no-images" id="noImages">
            <div class="no-images-icon">üçî</div>
            <div>No hay im√°genes para mostrar</div>
            <div style="font-size: 18px; margin-top: 15px; opacity: 0.7;">
                Sube im√°genes desde el panel de administraci√≥n
            </div>
        </div>
    </div>

    <div class="status-indicator" id="statusIndicator">
        üü¢ Conectado
    </div>

    <div class="image-counter" id="imageCounter">
        0 im√°genes
    </div>

    <div class="controls">
        <button class="control-btn" onclick="openMediaSelector()">üìÅ Seleccionar</button>
        <button class="control-btn" onclick="togglePlayPause()" id="playPauseBtn" style="display: none;">‚ñ∂ Reproducir</button>
        <button class="control-btn" onclick="refreshImages()">üîÑ Actualizar</button>
    </div>

    <div class="media-selector" id="mediaSelector">
        <button class="close-selector" onclick="closeMediaSelector()">√ó</button>
        <h3>üéØ Selecciona el contenido para esta pantalla</h3>
        <div class="media-grid" id="mediaGrid"></div>
        <div class="selector-controls">
            <button class="selector-btn" onclick="confirmSelection()">‚úÖ Confirmar</button>
            <button class="selector-btn secondary" onclick="closeMediaSelector()">‚ùå Cancelar</button>
        </div>
    </div>

    <script>
        // Configuraci√≥n de Drive (siempre carga desde aqu√≠)
        const DRIVE_API_KEY = 'AIzaSyBdTFn5HEMTCLCAx2TFQoSvNvm1tO7lVlk';
        const DRIVE_FOLDER_ID = '1cRVI_EL8CWK4jPo9Ah8w57D_AKXl2W3C';

        let currentSlide = 0;
        let images = [];
        let isPlaying = false; // Desactivado por defecto
        let slideInterval;
        const SLIDE_DURATION = 5000; // 5 segundos por imagen
        const REFRESH_INTERVAL = 5000; // Revisar nuevas im√°genes cada 5 segundos

        // Inicializar
        window.addEventListener('load', () => {
            // Guardar configuraci√≥n de Drive autom√°ticamente
            localStorage.setItem('driveApiKey', DRIVE_API_KEY);
            localStorage.setItem('driveFolderId', DRIVE_FOLDER_ID);
            
            // Sincronizar desde Drive primero
            syncFromDrive().then(() => {
                loadImages();
                loadSelectedMedia();
            });
            
            startAutoRefresh();
        });

        // Cargar im√°genes desde localStorage
        function loadImages() {
            const storedImages = JSON.parse(localStorage.getItem('displayImages') || '[]');
            images = storedImages;
        }

        // Abrir selector de media
        function openMediaSelector() {
            const selector = document.getElementById('mediaSelector');
            const mediaGrid = document.getElementById('mediaGrid');
            
            // Limpiar grid
            mediaGrid.innerHTML = '';
            
            // Agregar todas las opciones disponibles
            images.forEach((media, index) => {
                const item = document.createElement('div');
                item.className = 'media-item';
                item.dataset.mediaId = media.id;
                
                // Determinar si es video
                const isVideo = media.isVideo || (media.name && (media.name.toLowerCase().includes('.mp4') || media.name.toLowerCase().includes('.webm')));
                
                if (isVideo) {
                    let videoSrc = media.data;
                    if (media.fromDrive && media.driveId) {
                        // Usar proxy CORS alternativo para videos de Drive
                        const driveUrl = `https://drive.google.com/uc?export=download&id=${media.driveId}`;
                        videoSrc = `https://api.allorigins.win/raw?url=${encodeURIComponent(driveUrl)}`;
                    }
                    
                    item.innerHTML = `
                        <video style="width: 100%; height: 100%; object-fit: cover;" muted loop playsinline autoplay>
                            <source src="${videoSrc}" type="video/mp4">
                            <source src="${videoSrc}" type="video/webm">
                        </video>
                        <div class="video-indicator">üé•</div>
                    `;
                } else {
                    let imgSrc = media.data;
                    if (media.fromDrive && media.driveId) {
                        imgSrc = `https://images.weserv.nl/?url=${encodeURIComponent(`https://drive.google.com/uc?export=view&id=${media.driveId}`)}`;
                    }
                    item.innerHTML = `<img src="${imgSrc}" alt="${media.name}" style="width: 100%; height: 100%; object-fit: cover;">`;
                }
                
                // Click para seleccionar
                item.addEventListener('click', () => {
                    // Quitar selecci√≥n anterior
                    document.querySelectorAll('.media-item').forEach(el => el.classList.remove('selected'));
                    // Seleccionar actual
                    item.classList.add('selected');
                });
                
                mediaGrid.appendChild(item);
            });
            
            selector.classList.add('show');
        }

        // Cerrar selector de media
        function closeMediaSelector() {
            const selector = document.getElementById('mediaSelector');
            selector.classList.remove('show');
        }

        // Confirmar selecci√≥n
        function confirmSelection() {
            const selectedItem = document.querySelector('.media-item.selected');
            if (selectedItem) {
                const mediaId = selectedItem.dataset.mediaId;
                localStorage.setItem('selectedMediaId', mediaId);
                
                // Recargar la pantalla con la nueva selecci√≥n
                loadSelectedMedia();
                closeMediaSelector();
            }
        }

        // Cargar media seleccionada
        function loadSelectedMedia() {
            const selectedMediaId = localStorage.getItem('selectedMediaId');
            if (selectedMediaId) {
                // Buscar la media seleccionada
                const allMedia = JSON.parse(localStorage.getItem('displayImages') || '[]');
                const selectedMedia = allMedia.find(media => media.id == selectedMediaId);
                
                if (selectedMedia) {
                    displaySingleMedia(selectedMedia);
                } else {
                    showNoMedia();
                }
            } else {
                showNoMedia();
            }
        }

        // Mostrar una sola media (imagen o video)
        function displaySingleMedia(media) {
            const container = document.getElementById('slideshowContainer');
            const noImages = document.getElementById('noImages');
            const imageCounter = document.getElementById('imageCounter');
            const playPauseBtn = document.getElementById('playPauseBtn');

            // Limpiar slides existentes
            const existingSlides = container.querySelectorAll('.slide');
            existingSlides.forEach(slide => slide.remove());

            noImages.style.display = 'none';
            imageCounter.textContent = `üì∫ ${media.name}`;

            // Crear slide √∫nico
            const slide = document.createElement('div');
            slide.className = 'slide active';
            
            // Determinar si es video o imagen
            const isVideo = media.isVideo || (media.name && (media.name.toLowerCase().includes('.mp4') || media.name.toLowerCase().includes('.webm')));
            
            if (isVideo) {
                // Mostrar bot√≥n de play/pause para videos
                playPauseBtn.style.display = 'inline-block';
                playPauseBtn.textContent = '‚è∏ Pausar';
                
                // Crear elemento de video
                const video = document.createElement('video');
                video.muted = true;
                video.autoplay = true;
                video.loop = true;
                video.playsInline = true; // Para m√≥viles
                video.style.width = '100%';
                video.style.height = '100%';
                video.style.objectFit = 'contain';
                
                // Asegurar loop infinito
                video.addEventListener('ended', () => {
                    video.currentTime = 0;
                    video.play();
                });
                
                // Para videos de Drive, usar proxy para evitar CORS
                let videoSrc = media.data || media.url || '';
                if (media.fromDrive && media.driveId) {
                    // Usar proxy CORS alternativo para videos de Drive
                    const driveUrl = `https://drive.google.com/uc?export=download&id=${media.driveId}`;
                    videoSrc = `https://api.allorigins.win/raw?url=${encodeURIComponent(driveUrl)}`;
                }
                
                video.innerHTML = `
                    <source src="${videoSrc}" type="video/mp4">
                    <source src="${videoSrc}" type="video/webm">
                `;
                
                // Forzar reproducci√≥n en loop
                video.addEventListener('loadeddata', () => {
                    video.loop = true;
                    video.play();
                });
                
                // Manejar errores de video
                video.addEventListener('error', (e) => {
                    console.error('Error cargando video:', e);
                    imageCounter.textContent = `‚ùå Error cargando video: ${media.name}`;
                });
                
                slide.appendChild(video);
            } else {
                // Ocultar bot√≥n de play/pause para im√°genes
                playPauseBtn.style.display = 'none';
                
                // Crear elemento de imagen
                let imgSrc = media.data || media.url || '';
                if (media.fromDrive && media.driveId) {
                    // Usar proxy para im√°genes
                    imgSrc = `https://images.weserv.nl/?url=${encodeURIComponent(`https://drive.google.com/uc?export=view&id=${media.driveId}`)}`;
                }
                
                const imgElement = document.createElement('img');
                imgElement.src = imgSrc;
                imgElement.alt = media.name;
                imgElement.crossOrigin = 'anonymous';
                imgElement.style.width = '100%';
                imgElement.style.height = '100%';
                imgElement.style.objectFit = 'contain';
                
                // Fallback si la imagen no carga
                imgElement.onerror = function() {
                    this.onerror = null;
                    this.src = `https://cors-anywhere.herokuapp.com/${media.data || ''}`;
                };
                
                slide.appendChild(imgElement);
            }
            
            container.appendChild(slide);
        }

        // Mostrar pantalla sin contenido
        function showNoMedia() {
            const container = document.getElementById('slideshowContainer');
            const noImages = document.getElementById('noImages');
            const imageCounter = document.getElementById('imageCounter');

            // Limpiar slides existentes
            const existingSlides = container.querySelectorAll('.slide');
            existingSlides.forEach(slide => slide.remove());

            noImages.style.display = 'block';
            imageCounter.textContent = '0 contenido';
        }

        // Actualizar visualizaci√≥n (ahora solo para mostrar todas las opciones)
        function updateDisplay() {
            loadImages();
        }

        // Funci√≥n vac√≠a (ya no necesaria)
        function startSlideshow() {
            // No hace nada - sistema manual
        }

        // Funci√≥n vac√≠a (ya no necesaria)
        function stopSlideshow() {
            // No hace nada - sistema manual
        }

        // Toggle play/pause (solo para videos)
        function togglePlayPause() {
            const btn = document.getElementById('playPauseBtn');
            const video = document.querySelector('video');
            
            if (video) {
                if (video.paused) {
                    video.play();
                    btn.textContent = '‚è∏ Pausar';
                } else {
                    video.pause();
                    btn.textContent = '‚ñ∂ Reproducir';
                }
            } else {
                // Si no hay video, el bot√≥n no hace nada
                btn.textContent = '‚ñ∂ Reproducir';
            }
        }

        // Sincronizar desde Drive
        async function syncFromDrive() {
            try {
                const apiKey = DRIVE_API_KEY;
                const folderId = DRIVE_FOLDER_ID;
                
                // Cargar im√°genes y videos desde Drive
                const url = `https://www.googleapis.com/drive/v3/files?q='${folderId}'+in+parents+and+(mimeType+contains+'image/'+or+mimeType+contains+'video/')&key=${apiKey}&fields=files(id,name,mimeType,thumbnailLink,webContentLink)&supportsAllDrives=true`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error) {
                    console.log('Error sincronizando:', data.error.message);
                    return;
                }
                
                let images = JSON.parse(localStorage.getItem('displayImages') || '[]');
                
                // Limpiar archivos anteriores de Drive para evitar duplicados
                images = images.filter(img => !img.fromDrive);
                
                // Agregar referencias de Drive
                for (const file of data.files) {
                    const isVideo = file.mimeType && file.mimeType.startsWith('video/');
                    const isImage = file.mimeType && file.mimeType.startsWith('image/');
                    
                    // Para videos usar proxy, para im√°genes usar proxy
                    let mediaUrl;
                    if (isVideo) {
                        const driveUrl = `https://drive.google.com/uc?export=download&id=${file.id}`;
                        mediaUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(driveUrl)}`;
                    } else {
                        mediaUrl = `https://images.weserv.nl/?url=${encodeURIComponent(`https://drive.google.com/uc?export=view&id=${file.id}`)}`;
                    }
                    
                    images.push({
                        id: Date.now() + Math.random(),
                        name: file.name,
                        driveId: file.id,
                        data: mediaUrl,
                        uploadDate: new Date().toISOString(),
                        fromDrive: true,
                        isVideo: isVideo,
                        isImage: isImage,
                        webContentLink: file.webContentLink
                    });
                }
                
                localStorage.setItem('displayImages', JSON.stringify(images));
                console.log('‚úÖ Sincronizado desde Drive:', images.length, 'archivos');
                
            } catch (error) {
                console.log('Error sincronizando desde Drive:', error.message);
            }
        }

        // Actualizar im√°genes manualmente
        function refreshImages() {
            syncFromDrive().then(() => {
                loadImages();
            });
            const status = document.getElementById('statusIndicator');
            status.textContent = 'üîÑ Actualizando...';
            setTimeout(() => {
                status.textContent = 'üü¢ Conectado';
            }, 1000);
        }

        // Auto-refresh cada X segundos (sincroniza desde Drive)
        function startAutoRefresh() {
            setInterval(() => {
                // Sincronizar desde Drive cada 5 segundos
                syncFromDrive();
                
                // Actualizar la lista local
                loadImages();
                
                // Si no hay media seleccionada, mostrar selector
                if (!localStorage.getItem('selectedMediaId')) {
                    showNoMedia();
                }
            }, REFRESH_INTERVAL);
        }

        // Controles de teclado
        document.addEventListener('keydown', (e) => {
            switch(e.key) {
                case ' ':
                    e.preventDefault();
                    togglePlayPause();
                    break;
                case 'r':
                case 'R':
                    refreshImages();
                    break;
                case 's':
                case 'S':
                    openMediaSelector();
                    break;
            }
        });

        // Detectar cambios en localStorage desde otras pesta√±as
        window.addEventListener('storage', (e) => {
            if (e.key === 'displayImages') {
                loadImages();
                // Si no hay media seleccionada, mostrar selector
                if (!localStorage.getItem('selectedMediaId')) {
                    showNoMedia();
                }
            }
        });
    </script>
</body>
</html>